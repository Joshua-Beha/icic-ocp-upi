###############################################################################
# Â© Copyright IBM Corporation 2021
# Contributed by the Ansible Content for IBM Z Team
#
# Changelog
#  All notable changes to this sample will be documented in this playbook
#
# 2021-09-30
#  - Released initial version
###############################################################################

###############################################################################
# Requirements:
#     - IBM z/OS core collection 1.3.0 or later
###############################################################################

- hosts: zos_host
  collections:
    - ibm.ibm_zos_core
  gather_facts: no
  environment: "{{ environment_vars }}"
  vars:
    system_name: 'EC01129A'
    user_id: 'OMVSADM OMVSKERN'

  tasks:
    - block:
      - include_role:
          name: issue_operator_cmd
        vars:
          task_description: 'Start Health Check'
          command: "S HZSPROC"

      - include_role:
          name: issue_racf_cmd
        vars:
          task_description: 'Set up profiles'
          command:
            - RDEFINE XFACILIT HZS.{{system_name}}.*.*.MESSAGES UACC(NONE)
            - RDEFINE XFACILIT HZS.{{system_name}}.*.*.RUN UACC(NONE)
            - RDEFINE XFACILIT HZS.{{system_name}}.*.*.QUERY UACC(NONE)

      - include_role:
          name: issue_racf_cmd
        vars:
          task_description: 'Permit access to {{ user_id }}'
          command:
            - >
                PERMIT HZS.{{system_name}}.*.*.MESSAGES CLASS(XFACILIT) +
                  ID({{ user_id }}) ACCESS(READ)
            - >
                PERMIT HZS.{{system_name}}.*.*.RUN CLASS(XFACILIT) +
                  ID({{ user_id }}) ACCESS(UPDATE)
            - >
                PERMIT HZS.{{system_name}}.*.*.QUERY CLASS(XFACILIT) +
                  ID({{ user_id }}) ACCESS(READ)

      - include_role:
          name: issue_racf_cmd
        vars:
          task_description: 'Activate and refresh RACF profile '
          command:
            - SETROPTS CLASSACT(XFACILIT)
            - SETROPTS RACLIST(XFACILIT) REFRESH

