###############################################################################
# Â© Copyright IBM Corporation 2020
# Contributed by the Ansible Content for IBM Z Team
#
# Changelog
#  All notable changes to this sample will be documented in this playbook
#
# 2020-09-01
#  - Released initial version
###############################################################################

###############################################################################
# Requirements:
#     - IBM z/OS core collection 1.2.0 or later
###############################################################################

- hosts: zos_host
  collections:
    - ibm.ibm_zos_core
  gather_facts: no
  environment: "{{ environment_vars }}"

  tasks:
    # - name: Copy SSH Key
    #   command: 'ssh-copy-id -i ~/.ssh/id_rsa.pub omvsadm@ec01129a.vmec.svl.ibm.com'

    - name: Set up zoau100 file path
      zos_job_submit:
        src: IMSTESTL.ZOAU100.SMPE.JOBS(BGY4ZFS)
        location: DATA_SET
        wait: true
    - name: Set up zoau100 install directory
      zos_job_submit:
        src: IMSTESTL.ZOAU100.SMPE.JOBS(BGY5MKD)
        location: DATA_SET
        wait: true
    - name: Set up zoau110 install directory
      zos_job_submit:
        src: IMSTESTL.ZOAU110.SMPE.JOBS(MOUNTZFS)
        location: DATA_SET
        wait: true
    - name: copy .profile
      zos_copy:
        src: "USER.PRIVATE.PROCLIB(PROFILE)"
        dest: /u/omvsadm/.profile
        remote_src: true
    - name: install zoautil_py
      shell:
        cmd: cp "//'user.private.proclib(profile)'" /u/omvsadm/.profile
    - name: install zoautil_py
      shell:
        cmd: ". .profile"
        chdir: /var/zoau110/
    - name: install zoautil_py
      shell:
        cmd: "pip3 install /var/zoau110/zoautil_py-1.1.0.tar.gz"
        chdir: /var/zoau110/

    - name: Set up certficate for SMPE internet retrieval
      zos_mvs_raw:
        pgm: ikjeft01
        auth: yes
        parm: "REGIONS=0K"
        dds:
          - dd_output:
              dd_name: sysprint
              return_content:
                type: text
          - dd_output:
              dd_name: systsprt
              return_content:
                type: text
          - dd_output:
              dd_name: sysdump
              return_content:
                type: text
          - dd_input:
              dd_name: systsin
              content:
                  - RDEFINE FACILITY IRR.DIGTCERT.ADD      UACC(NONE)
                  - RDEFINE FACILITY IRR.DIGTCERT.ADDRING  UACC(NONE)
                  - RDEFINE FACILITY IRR.DIGTCERT.ALTER    UACC(NONE)
                  - RDEFINE FACILITY IRR.DIGTCERT.CONNECT  UACC(NONE)
                  - RDEFINE FACILITY IRR.DIGTCERT.LIST     UACC(NONE)
                  - RDEFINE FACILITY IRR.DIGTCERT.LISTRING UACC(NONE)
                  - PERMIT IRR.DIGTCERT.ADD      CLASS(FACILITY) ID(OMVSADM) ACCESS(READ)
                  - PERMIT IRR.DIGTCERT.ADDRING  CLASS(FACILITY) ID(OMVSADM) ACCESS(READ)
                  - PERMIT IRR.DIGTCERT.ALTER    CLASS(FACILITY) ID(OMVSADM) ACCESS(READ)
                  - PERMIT IRR.DIGTCERT.CONNECT  CLASS(FACILITY) ID(OMVSADM) ACCESS(UPDATE)
                  - PERMIT IRR.DIGTCERT.LIST     CLASS(FACILITY) ID(OMVSADM) ACCESS(READ)
                  - PERMIT IRR.DIGTCERT.LISTRING CLASS(FACILITY) ID(OMVSADM) ACCESS(READ)
                  - RACDCERT ID(OMVSADM) ADDRING(SMPERING)
                  - RACDCERT ID(OMVSADM) LISTRING(SMPERING)
                  - RACDCERT ID(OMVSADM) ADD('IMSTESTL.ZOAU100.SMPE.USER.CERT') +
                  - WITHLABEL('SMPE Client Certificate') PASSWORD('smpeansible') TRUST
                  - RACDCERT CERTAUTH ADD('IMSTESTL.ZOAU100.SMPE.CA.CERT') +
                  - WITHLABEL('DigiCert Global Root CA') TRUST
                  - RACDCERT ID(OMVSADM) CONNECT(LABEL('SMPE Client Certificate') +
                  - RING(SMPERING) USAGE(CERTAUTH) )
                  - RACDCERT ID(OMVSADM) +
                  - CONNECT( CERTAUTH LABEL('DigiCert Global Root CA') +
                  - RING(SMPERING) USAGE(CERTAUTH) )
                  - RACDCERT CERTAUTH LIST(LABEL('DigiCert Global Root CA'))
                  - RACDCERT ID(OMVSADM) LIST(LABEL('SMPE Client Certificate'))
                  - SETROPTS CLASSACT(DIGTCERT DIGTRING)
                  - SETROPTS RACLIST(FACILITY DIGTCERT DIGTRING) REFRESH
